<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Gobblet Gobblers Server</title>
    <style>

    </style>    
</head>
<body>
    <div id="debugText">
        Waiting for Conection
    </div>
</body>
	<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script>
		var peer;
		var conn;
	
	    function PrintLog(str) {
            document.getElementById('debugText').innerHTML = "Debug : " + str;
            console.log(str);
            setTimeout(function(){
                document.getElementById('debugText').innerHTML = ""
                }, 3000);
        }
	
		peer = new Peer("RNS111", {debug: 2});
		
		peer.on('open', function (id) {
			// Workaround for peer.reconnect deleting previous id
			if (peer.id === null) {
				console.log('Received null id from peer open');
				peer.id = lastPeerId;
            } else {
                lastPeerId = peer.id;
            }

            console.log('ID: ' + peer.id);
            PrintLog("ID: " + peer.id + " " + "Awaiting connection...");
            
            });
		
		peer.on('connection', function (c) {
            // Allow only a single connection
            if (conn && conn.open) {
				c.on('open', function() {
					c.send("Already connected to another client");
					setTimeout(function() { c.close(); }, 500);
				});
				return;
            }

            conn = c;
			InitializeConnection();
            console.log("Connected to: " + conn.peer);
            PrintLog("Connected");	

			
        });
			
        peer.on('disconnected', function () {
			PrintLog("Connection lost. Please reconnect");
			console.log('Connection lost. Please reconnect');
			// Workaround for peer.reconnect deleting previous id
			peer.id = lastPeerId;
            peer._lastServerId = lastPeerId;
            peer.reconnect();
        });
			
        peer.on('close', function() {
            conn = null;
            PrintLog("Connection destroyed. Please refresh");
            console.log('Connection destroyed');
        });
			
        peer.on('error', function (err) {
            console.log(err);
            alert('' + err);
        });
		
		function InitializeConnection() {
			conn.on('open', function () {
				PrintLog("Connected to: " + conn.peer);
				console.log("Connected to: " + conn.peer);
			});
			
			// Handle incoming data (messages only since this is the signal sender)
			conn.on('data', function (data) {
				PrintLog(data);
				conn.send("Hello from server");
			});
			
			conn.on('close', function () {
				PrintLo("Connection closed");
			});
		}		
    </script>
</html>
