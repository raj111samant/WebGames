<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Gobblet Gobblers Client</title>
    <style>

    </style>    
</head>
<body>
    <div id="debugText">
        Waiting for Conection
    </div>
</body>
	<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script>
		var peer = null;
		var conn = null;
	
		function PrintLog(str) {
            document.getElementById('debugText').innerHTML = "Debug : " + str;
            console.log(str);
            setTimeout(function(){
                document.getElementById('debugText').innerHTML = ""
            }, 3000);
        }
	
		peer = new Peer(null, {debug: 2});

        peer.on('open', function (id) {
			// Workaround for peer.reconnect deleting previous id
            if (peer.id === null) {
				console.log('Received null id from peer open');
				peer.id = lastPeerId;
            } else {
                lastPeerId = peer.id;
            }

            console.log('ID: ' + peer.id);
			
			// Create connection to destination peer specified in the input field
			conn = peer.connect("RNS111", {reliable: true});
			InitializeConnection();
			conn.send("Hi from client");
			console.log(conn);
        });
			
        peer.on('connection', function (c) {
            // Disallow incoming connections
            c.on('open', function() {
			c.send("Sender does not accept incoming connections");
			setTimeout(function() { c.close(); }, 500);
            });
				
        });
			
        peer.on('disconnected', function () {
			PrintLog("Connection lost. Please reconnect");
			console.log('Connection lost. Please reconnect');
			// Workaround for peer.reconnect deleting previous id
			peer.id = lastPeerId;
            peer._lastServerId = lastPeerId;
            peer.reconnect();
        });
			
        peer.on('close', function() {
            conn = null;
            PrintLog("Connection destroyed. Please refresh");
            console.log('Connection destroyed');
        });
			
        peer.on('error', function (err) {
            console.log(err);
            alert('' + err);
        });


        if (conn != null) {
			conn.close();
        }


		function InitializeConnection() {
			conn.on('open', function () {
				PrintLog("Connected to: " + conn.peer);
				console.log("Connected to: " + conn.peer);
				conn.send("Hi from client");
			});
			
			// Handle incoming data (messages only since this is the signal sender)
			conn.on('data', function (data) {
				PrintLog(data);
			});
			
			conn.on('close', function () {
				PrintLo("Connection closed");
			});
			
			console.log(conn.open);
			conn.send("Hello World");
		}
    </script>
</html>
